<!DOCTYPE html>
<html>
	<!--This page prompts a user to select a highway and then directs the user to the right page for estimations-->
<head>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<script src="https://code.jquery.com/jquery-3.1.1.min.js">
	</script>
	<link href="semantic/dist/semantic.min.css" rel="stylesheet" type="text/css">
	<script src="semantic/dist/semantic.min.js">
	</script>
	<title>Upload Sensor File</title>
	<link href="semantic/dist/components/reset.css" rel="stylesheet" type="text/css">
	<link href="semantic/dist/components/site.css" rel="stylesheet" type="text/css">
	<link href="semantic/dist/components/container.css" rel="stylesheet" type="text/css">
	<link href="semantic/dist/components/divider.css" rel="stylesheet" type="text/css">
	<link href="semantic/dist/components/header.css" rel="stylesheet" type="text/css">
	<link href="semantic/dist/components/grid.css" rel="stylesheet" type="text/css">
	<link href="css/upload_file.css" rel="stylesheet" type="text/css">
</head>

<style>
	body{
		background-color: #d1d2d3;
	}
	
	#summary {
		color: #ff0800;
	}
	#container {
		width: 800px;
		height: 600px;

		border-style: solid;
		border-color: #6186aa;
		border-width: 25px 5px 5px 5px;		   
	}

	#highway_pic img {
		  width: auto;
		  height: 100%;
	}
	#row1-size {
		width: 790x;
		height: 40px;
		background-color: white;
	}
	#row2-size {
		width: 790px;
		height: 450px;
	
		/*background: url("images/highway.gif") no-repeat scroll center top/ 100% 100%;*/
	}
	#column-size {
		width: 400px;
		height: 40px;
	}
	#row3-size {
		width: 400px;
		height: 50px;
	}
	#row4-size {
		width: 400px;
		height: 50px;
	}
	#grid-size {
		width: 790px;
		height: 570px;
	}
	#label {
		padding: 175px 20px 35px 20px;
	}
	#choice {
		padding: 200px 20px 35px 10px;
	}
	#choice2 {
		padding: 10px 20px 35px 10px;
	}
	#button-row {
		width:790px;
		height: 80px;
		background-color: white;
	}
</style>

<script>
</script>

<body>
<div class="ui container" id="container">
	<div class="ui gird" id="grid-size">
		<div class="one column row"  id="row1-size">
			<p style="font-size:25px; font-weight:bold">Please upload a sensor data file to begin analysis:</p>
		</div>
		<div class="one column row" id="row2-size">
			<!-- 
			<form action="/action_page.php">
				<label for="myfile">Select files:</label>
				<input type="file" id="myfile" name="myfile" multiple><br><br>
				<input type="submit">
			</form>-->

			<label for="uploadedfile">Select files:</label>
			<input type="file" id="uploadedfile" name="uploadedfile"> <!-- accept CSV only???-->
			
			<p class="content"></p>
		</div>

		<div class="column" id="button-row">
			<div class="one column row" id="button-row">
				<button class="ui right floated blue button" id="Next" onclick='nextPage()'>Analyze</button>
				<script type="text/javascript">
					function nextPage() {
						document.querySelector('#Next').textContent  = "Next File";
						const content = document.querySelector('.content');
						const fileList = document.getElementById('uploadedfile').files;
						content.innerText = "Analyzing File...\n";

						for (let i = 0; i < fileList.length; i++) {
							const reader = new FileReader();
							const file = fileList[i];

							let fileInfo = new Object();
							// Constants
							fileInfo.numDataPoints = 0;
							fileInfo.zoneId = 0;
							fileInfo.laneNumber = 0;
							fileInfo.laneId = 0;

							// Measurements
							fileInfo.measurementTime = 0;
							fileInfo.speed = 0;
							fileInfo.volume = 0;
							fileInfo.occupancy = 0;
							fileInfo.quality = 0;

							/* Three possible outcomes:
							* 1: Faulty
							* 2: Questionable
							* 3: Non-faulty
							*/
							fileInfo.outcome = 0;

							reader.onload = (event) => {
								// Reading line by line
								const fileLines = reader.result.split(/\r\n|\n/);
								
								// Need to skip first line header
								fileLines.splice(0, 1);

								fileLines.every(line => {
									if(line != "") {
										alert(fileInfo.error);
										processLine(line, fileInfo)
										if(fileInfo.error != undefined){
											content.innerText += fileInfo.error + "\n";
											return false;
										}

										return true;
									}
									return false;
								});

								//content.innerText += "Number of Sensor Data Points: " + fileInfo.numDataPoints;
							};

							if (file) {
								reader.readAsText(file);
							}
						}
					}

					/**
					 * Function to take input of a sensor data point line, and process.
					 * @params: line (str), fileInfo (Object)
					 */ 
					function processLine(line, fileInfo) {
						fileInfo.numDataPoints += 1;

						const lineSplit = line.split(",");
						
						// prevent zoneId, laneNumber, laneId from changing
						const proceed = checkIdError(fileInfo, lineSplit[0], lineSplit[1], lineSplit[2]);
						if(!proceed) {
							return false;
						}

						// Line order: zone_id, lane_number, lane_id, measurement_start, speed, volume, occupancy, quality
						const date = new Date(lineSplit[3]);
						//alert(date);

					}

					function checkIdError(fileInfo, lineZoneId, lineLaneNumber, lineLaneId) {
						if(fileInfo.zoneId == 0) {
							fileInfo.zoneId = lineZoneId;
						}
						else if(fileInfo.zoneId != lineZoneId){
							fileInfo.error = "zone_id changed mid-file";
							return false;
						}
						if(fileInfo.laneNumber == 0) {
							fileInfo.laneNumber = lineLaneNumber;
						}
						else if(fileInfo.laneNumber != lineLaneNumber){
							fileInfo.error = "lane_number changed mid-file";
							return false;
						}
						if(fileInfo.laneId == 0) {
							fileInfo.laneId = lineLaneId;
						}
						else if(fileInfo.laneId != lineLaneId){
							fileInfo.error = "lane_id changed mid-file";
							return false;
						}

						return true;
					}

					function isRushDay(date) {

					}

					function isPeakHour(hour) {

					}
				</script>
			</div>
		</div>
	</div>
</div>
</body>
</html>